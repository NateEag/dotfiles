// Generated by CoffeeScript 1.6.3
var Q, cli;

Q = require('q');

cli = require('../cli');

module.exports = function(program) {
  return program.command('reinstall [names]').description('reinstall virtual machines').option('-s, --shrink', 'Shrink the virtual machines after installing').action(function(names, command) {
    return cli.fail(cli.find(names, '!missing').found().then(function(vms) {
      return cli.dsl(vms).where('running').all(function(vm) {
        return vm.stop(false);
      }).then(function() {
        return cli.dsl(vms).groupReused(function(xps, win7s, rest) {
          var r;
          r = function(vm) {
            return vm.reinstall();
          };
          return Q.all([xps.seq(r), win7s.seq(r), rest.all(r)]).then(function() {
            if (!command.shrink) {
              return null;
            }
            return xps.then(function(xps) {
              return win7s.then(function(win7s) {
                return rest.then(function(rest) {
                  if (xps.length > 0) {
                    rest.push(xps[0]);
                  }
                  if (win7s.length > 0) {
                    rest.push(win7s[0]);
                  }
                  return cli.dsl(rest).where('ovaed').all(function(vm) {
                    return vm.unova();
                  });
                });
              });
            });
          });
        });
      });
    }));
  });
};
