// Generated by CoffeeScript 1.6.3
var Q, cli;

Q = require('q');

cli = require('../cli');

module.exports = function(program) {
  return program.command('nuke [names]').description('remove all traces of virtual machines').action(function(names, command) {
    return cli.fail(cli.find(names).found().then(function(vms) {
      return cli.dsl(vms).where('running').all(function(vm) {
        return vm.stop(false);
      }).then(function() {
        return cli.dsl(vms).where('!missing').groupReused(function(xps, win7s, rest) {
          var u;
          u = function(vm) {
            return vm.uninstall();
          };
          return Q.all([xps.seq(u), win7s.seq(u), rest.all(u)]).then(function() {
            return cli.dsl(vms).groupReused(function(xps, win7s, rest) {
              return xps.then(function(xps) {
                return win7s.then(function(win7s) {
                  return rest.then(function(rest) {
                    if (xps.length > 0) {
                      rest.push(xps[0]);
                    }
                    if (win7s.length > 0) {
                      rest.push(win7s[0]);
                    }
                    return cli.dsl(rest).all(function(vm) {
                      vm.unova();
                      return vm.unarchive();
                    });
                  });
                });
              });
            });
          });
        });
      });
    }));
  });
};
