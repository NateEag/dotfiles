#! /bin/bash

# On OS X Mojave, /usr/share/emacs/ contains elisp that causes make-process to
# take at least five seconds before actually creating the child process.
#
# Because the only runtime way to skip loading site files is to pass
# --no-site-file (see
# https://www.gnu.org/software/emacs/manual/html_node/emacs/Init-File.html),
# I've added the below to my personal build configuration, so that my Emacs
# builds ignore site files. A wrapper binary that always passes --no-site-file
# doesn't play well with OS X's Emacs.app, and editing or removing the site
# files themselves means bypassing SIP on Mojave, which didn't seem ideal.
echo "(setq site-run-file nil)" > ./lisp/site-init.el

# My configuration for building Emacs from source for use on OS X. Easier to
# tweak things in the build if I have this automated.
#
# Note that when building from a Git checkout, you'll need to run
# `./autogen.sh` first, per the CONTRIBUTE document in the project's
# repository.
#
# Largely ripped from this post on Reddit:
#
# https://www.reddit.com/r/emacs/comments/bclyyc/building_emacs_from_source_on_macos/
#
# Note that the second instance of CPPFLAGS is a workaround for brew not
# including libxml2's include files in /usr/local/include.

./configure --with-ns \
            --with-modules \
            --enable-silent-rules \
            PKG_CONFIG_PATH=/opt/local/lib/pkgconfig \
            LDFLAGS="-L/usr/local/lib" \
            LDFLAGS="-L/usr/lib" \
            CPPFLAGS="-I/usr/local/include" \
            CPPFLAGS="-I$(brew --prefix libxml2)/include/libxml2" \
            CC=clang OBJC=clang CFLAGS="-g -O2"
