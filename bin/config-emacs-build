#! /bin/bash

# On OS X Mojave, /usr/share/emacs/ contains elisp that causes make-process to
# take at least five seconds before actually creating the child process.
#
# Because the only runtime way to skip loading site files is to pass
# --no-site-file, I've added the below to my personal build configuration, so
# that my Emacs builds ignore site files. A wrapper binary that always passes
# --no-site-file doesn't play well with OS X's Emacs.app, and editing or
# removing the site files themselves means bypassing SIP on Mojave, which
# didn't seem ideal.
#
# N.B.: I have not tested this approach exactly. In the build that worked, I
# put this file in place by hand. It's possible this needs to be there before
# autogen.sh runs.
#
# I just thought this was the obvious place to document it.
echo "(setq site-run-file)" > ./lisp/site-init.el

# My configuration for building Emacs from source for use on OS X. Largely done
# so that I can have automatic resizing of images to fit in a frame when
# reading email, which only works if ImageMagick support is compiled into your
# build (and in turn that doesn't just happen in the Emacs for OS X builds:
# https://github.com/caldwell/build-emacs/issues/1).
#
# Note that when building from a Git checkout, you'll need to run
# `./autogen.sh` first, per the CONTRIBUTE document in the project's
# repository.
#
# Largely ripped from this post on Reddit:
#
# https://www.reddit.com/r/emacs/comments/bclyyc/building_emacs_from_source_on_macos/
#
# Note that the second instance of CPPFLAGS is a workaround for brew not
# including libxml2's include files in /usr/local/include.

./configure --with-ns \
            --with-imagemagick \
            --with-modules \
            --enable-silent-rules \
            PKG_CONFIG_PATH=/opt/local/lib/pkgconfig \
            LDFLAGS="-L/usr/local/lib" \
            LDFLAGS="-L/usr/lib" \
            CPPFLAGS="-I/usr/local/include" \
            CPPFLAGS="-I/usr/local/Cellar/libxml2/2.9.7/include/libxml2" \
            CC=clang OBJC=clang CFLAGS="-g -O2"
